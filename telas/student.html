<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Treino</title>
    <link rel="stylesheet" href="../css/style.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../js/app_global.js"></script>

    <style>
        .content {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: var(--glass-blur);
            padding: 1.5rem;
            border-radius: 0 0 24px 24px;
            min-height: 300px;
            border: 1px solid var(--glass-border);
            border-top: none;
        }

        .timer-container {
            margin-top: 1rem;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .timer-display {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-family: monospace;
        }

        .timer-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .completed-exercise {
            opacity: 0.5;
            background-color: #f0f0f0 !important;
            transition: all 0.3s;
        }

        .completed-exercise h3 {
            text-decoration: line-through;
        }

        .btn-check {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
        }

        .btn-uncheck {
            background-color: var(--text-muted);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
        }

        /* Container para v√≠deos e fotos embutidos */
        .media-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            /* Reduz o tamanho m√°ximo */
            padding-bottom: 56.25%;
            /* 16:9 Ratio */
            height: 0;
            margin: 1rem auto;
            /* Centraliza e d√° margem */
            border-radius: 12px;
            overflow: hidden;
            background: #eee;
            border: 1px solid var(--border);
        }

        .media-container iframe,
        .media-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            object-fit: cover;
        }

        .media-tabs {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
    </style>
</head>

<body>

    <header class="container">
        <div class="app-header" style="padding: 1rem 1.5rem;">
            <div>
                <h1 style="font-size: 1.25rem; color: var(--primary);">Meu <span
                        style="font-weight: 300; color: var(--text-dark);">Treino</span></h1>
                <p style="font-size: 0.85rem; color: var(--text-muted);">Aluno: <span id="studentName"
                        style="font-weight: 600; color: var(--text-dark);">...</span></p>
            </div>
            <button onclick="window.fazerLogout()" class="btn btn-danger btn-sm"
                style="padding: 0.4rem 0.8rem;">Sair</button>
        </div>
    </header>

    <main class="container">
        <div class="days-carousel">
            <div class="day-tab active" onclick="verDia('segunda', this)">Segunda</div>
            <div class="day-tab" onclick="verDia('terca', this)">Ter√ßa</div>
            <div class="day-tab" onclick="verDia('quarta', this)">Quarta</div>
            <div class="day-tab" onclick="verDia('quinta', this)">Quinta</div>
            <div class="day-tab" onclick="verDia('sexta', this)">Sexta</div>
            <div class="day-tab" onclick="verDia('sabado', this)">S√°bado</div>
            <div class="day-tab" onclick="verDia('domingo', this)">Domingo</div>
        </div>

        <div class="content" id="treinoContainer">
            <p style="color: #777;">Carregando...</p>
        </div>
    </main>

    <script>
        window.verificarAuthAluno();

        document.getElementById('studentName').innerText = sessionStorage.getItem("studentName") || 'Aluno';
        const studentId = sessionStorage.getItem("studentId");
        const firestore = firebase.firestore();

        let treinoCache = {};

        function carregarTreino() {
            firestore.collection("workouts").doc(studentId).get().then((doc) => {
                if (doc.exists) {
                    treinoCache = doc.data().days || {};

                    // Detecta o dia da semana atual
                    const diasMap = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
                    const diaHj = diasMap[new Date().getDay()];

                    // Procura o elemento da aba correspondente ao dia de hoje
                    const tabs = document.querySelectorAll('.day-tab');
                    let tabHj = tabs[0]; // Fallback para primeira aba (Segunda)
                    tabs.forEach(t => {
                        // Verifica se o texto do bot√£o cont√©m parte do nome do dia atual
                        if (t.textContent.toLowerCase().includes(diaHj.substring(0, 3))) {
                            tabHj = t;
                        }
                    });

                    verDia(diaHj, tabHj);
                } else {
                    document.getElementById('treinoContainer').innerText = "Nenhum treino encontrado.";
                }
            });
        }

        window.verDia = function (dia, elBtn) {
            document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
            if (elBtn) elBtn.classList.add('active');

            const container = document.getElementById('treinoContainer');
            container.innerHTML = '';

            const exerciciosOriginal = treinoCache[dia] || [];

            // Cria uma c√≥pia e ordena: os conclu√≠dos v√£o para o final
            const exercicios = [...exerciciosOriginal].sort((a, b) => {
                const aDone = isExCompleted(a.name, dia);
                const bDone = isExCompleted(b.name, dia);
                if (aDone && !bDone) return 1;
                if (!aDone && bDone) return -1;
                return 0;
            });

            if (exercicios.length === 0) {
                container.innerHTML = '<p>Descanso ou sem treino cadastrado.</p>';
                return;
            }

            exercicios.forEach((ex, index) => {
                const div = document.createElement('div');
                div.className = 'card exercise-card'; // Usa a nova classe com borda lateral
                div.id = `exercise-card-${index}`;
                div.style.padding = '1.5rem';

                const isCompleted = isExCompleted(ex.name, dia);
                if (isCompleted) div.classList.add('completed-exercise');

                // L√≥gica de M√≠dia Embutida
                let midiaHtml = '';
                if (ex.videoLink) {
                    const embedUrl = getEmbedUrl(ex.videoLink);
                    midiaHtml += `
                        <div class="media-container" style="margin-bottom: 0.5rem;">
                            <iframe src="${embedUrl}" title="V√≠deo do exerc√≠cio" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen></iframe>
                        </div>
                        <div style="text-align:center; margin-bottom: 1rem;">
                            <a href="${ex.videoLink}" target="_blank" style="font-size: 0.8rem; color: var(--primary); text-decoration: none;">
                                üì∫ Abrir v√≠deo caso n√£o carregue
                            </a>
                        </div>
                    `;
                }
                if (ex.photoLink) {
                    midiaHtml += `
                        <div class="media-container">
                            <img src="${ex.photoLink}" alt="Demonstra√ß√£o">
                        </div>
                    `;
                }

                const rest = ex.restTime || 60;
                const min = Math.floor(rest / 60).toString().padStart(2, '0');
                const sec = (rest % 60).toString().padStart(2, '0');

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:1rem; align-items: start;">
                        <div style="flex: 1;">
                            <h3 style="color:var(--text-dark); margin-bottom:0.4rem; font-size: 1.25rem;">${ex.name}</h3>
                            <div style="display: flex; gap: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                                <span><strong>${ex.sets}</strong> S√©ries</span>
                                <span><strong>${ex.reps}</strong> Repeti√ß√µes</span>
                            </div>
                        </div>
                        <div style="font-size: 1.1rem; font-weight: 800; color: var(--primary); background: rgba(99, 102, 241, 0.1); padding: 0.4rem 0.8rem; border-radius: 10px;">
                            ${rest}s
                        </div>
                    </div>
                    
                    ${midiaHtml}

                    <div class="timer-container" id="timer-${ex.name.replace(/\s+/g, '-')}">
                        <div style="font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 0.5rem;">Cron√¥metro de Descanso</div>
                        <div class="timer-display" style="margin-bottom: 1rem;">${min}:${sec}</div>
                        <div class="timer-controls">
                            <button class="btn btn-sm btn-primary" onclick="toggleTimer(this, ${rest})" style="flex: 1;">Iniciar</button>
                            <button class="btn btn-sm" style="background:rgba(226, 232, 240, 0.8); color:var(--text-main); flex: 1;" onclick="resetTimer(this, ${rest})">Resetar</button>
                        </div>
                    </div>

                    <button class="${isCompleted ? 'btn-uncheck' : 'btn-check'}" onclick="toggleConcluido('${ex.name}', '${dia}', ${index})" style="margin-top: 1.5rem; transition: all 0.2s;">
                        <span style="font-size: 1.1rem; margin-right: 0.5rem;">${isCompleted ? '‚Ü©Ô∏è' : '‚úÖ'}</span>
                        ${isCompleted ? 'Desmarcar Exerc√≠cio' : 'Concluir Exerc√≠cio'}
                    </button>
                `;
                container.appendChild(div);
            });
        };

        /**
         * Converte links normais do YouTube para o formato de embed (iframe)
         */
        function getEmbedUrl(url) {
            if (!url) return '';
            if (url.includes('youtube.com/embed/')) return url;

            // Regex robusta para capturar IDs de v√≠deos do YouTube em diversos formatos
            const regExp = /^.*(?:(?:youtu\.be\/|v\/|vi\/|u\/\w\/|embed\/|shorts\/)|(?:(?:watch)?\?v(?:i)?=|\&v(?:i)?=))([^#\&\?]*).*/;
            const match = url.match(regExp);

            if (match && match[1] && match[1].length === 11) {
                return `https://www.youtube-nocookie.com/embed/${match[1]}?rel=0&modestbranding=1`;
            }
            return url;
        }

        let activeTimers = {};

        window.toggleTimer = function (btn, restTime) {
            const container = btn.closest('.timer-container');
            const display = container.querySelector('.timer-display');
            const timerId = container.id;

            if (activeTimers[timerId] && activeTimers[timerId].running) {
                // Pausar
                clearInterval(activeTimers[timerId].interval);
                activeTimers[timerId].running = false;
                btn.innerText = 'Retomar';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-primary');
            } else {
                // Iniciar ou Retomar
                let timeLeft = (activeTimers[timerId] && activeTimers[timerId].timeLeft) ? activeTimers[timerId].timeLeft : restTime;

                btn.innerText = 'Pausar';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-danger');

                const interval = setInterval(() => {
                    timeLeft--;
                    if (activeTimers[timerId]) activeTimers[timerId].timeLeft = timeLeft;
                    updateDisplay(display, timeLeft);

                    if (timeLeft <= 0) {
                        clearInterval(interval);
                        delete activeTimers[timerId];
                        btn.innerText = 'Iniciar Descanso';
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-primary');
                        tocarAlarme();
                    }
                }, 1000);

                activeTimers[timerId] = { interval, timeLeft, running: true };
            }
        };

        window.resetTimer = function (btn, restTime) {
            const container = btn.closest('.timer-container');
            const display = container.querySelector('.timer-display');
            const timerId = container.id;
            const startBtn = container.querySelector('.timer-controls button:first-child');

            if (activeTimers[timerId]) {
                clearInterval(activeTimers[timerId].interval);
                delete activeTimers[timerId];
            }

            startBtn.innerText = 'Iniciar Descanso';
            startBtn.classList.remove('btn-danger');
            startBtn.classList.add('btn-primary');
            updateDisplay(display, restTime);
        };

        function updateDisplay(display, seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            display.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function tocarAlarme() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // Toca 3 bipes r√°pidos para chamar a aten√ß√£o
            [0, 0.4, 0.8].forEach(delay => {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.type = 'square'; // Som mais 'cortado' de alarme
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime + delay);

                gainNode.gain.setValueAtTime(0, audioCtx.currentTime + delay);
                gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + delay + 0.05);
                gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + delay + 0.3);

                oscillator.start(audioCtx.currentTime + delay);
                oscillator.stop(audioCtx.currentTime + delay + 0.3);
            });
        }

        function isExCompleted(nome, dia) {
            const hoje = new Date().toISOString().split('T')[0];
            const logs = JSON.parse(localStorage.getItem(`progress_${studentId}_${hoje}`) || '{}');
            return logs[dia] && logs[dia].includes(nome);
        }

        window.toggleConcluido = function (nome, dia, index) {
            const hoje = new Date().toISOString().split('T')[0];
            const key = `progress_${studentId}_${hoje}`;
            let logs = JSON.parse(localStorage.getItem(key) || '{}');

            if (!logs[dia]) logs[dia] = [];

            const card = document.getElementById(`exercise-card-${index}`);

            if (logs[dia].includes(nome)) {
                logs[dia] = logs[dia].filter(n => n !== nome);
                card.classList.remove('completed-exercise');
            } else {
                logs[dia].push(nome);
                card.classList.add('completed-exercise');
            }

            localStorage.setItem(key, JSON.stringify(logs));
            verDia(dia, document.querySelector(`.day-tab.active`)); // Atualiza bot√µes
        };

        carregarTreino();
    </script>
</body>

</html>