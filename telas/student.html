<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Treino</title>
    <link rel="stylesheet" href="../css/style.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../js/app_global.js"></script>

    <style>
        .content {
            background: white;
            padding: 1.5rem;
            border-radius: 0 0 16px 16px;
            min-height: 300px;
        }

        .timer-container {
            margin-top: 1rem;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .timer-display {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-family: monospace;
        }

        .timer-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .completed-exercise {
            opacity: 0.5;
            background-color: #f0f0f0 !important;
            transition: all 0.3s;
        }

        .completed-exercise h3 {
            text-decoration: line-through;
        }

        .btn-check {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
        }

        .btn-uncheck {
            background-color: var(--text-muted);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
        }
    </style>
</head>

<body>

    <header class="container">
        <div class="app-header">
            <div>
                <h1>Meu Treino</h1>
                <p>Aluno: <span id="studentName">...</span></p>
            </div>
            <button onclick="window.fazerLogout()" class="btn btn-danger btn-sm">Sair</button>
        </div>
    </header>

    <main class="container">
        <div class="days-carousel">
            <div class="day-tab active" onclick="verDia('segunda', this)">Segunda</div>
            <div class="day-tab" onclick="verDia('terca', this)">Terça</div>
            <div class="day-tab" onclick="verDia('quarta', this)">Quarta</div>
            <div class="day-tab" onclick="verDia('quinta', this)">Quinta</div>
            <div class="day-tab" onclick="verDia('sexta', this)">Sexta</div>
            <div class="day-tab" onclick="verDia('sabado', this)">Sábado</div>
            <div class="day-tab" onclick="verDia('domingo', this)">Domingo</div>
        </div>

        <div class="content" id="treinoContainer">
            <p style="color: #777;">Carregando...</p>
        </div>
    </main>

    <script>
        window.verificarAuthAluno();

        document.getElementById('studentName').innerText = sessionStorage.getItem("studentName") || 'Aluno';
        const studentId = sessionStorage.getItem("studentId");
        const firestore = firebase.firestore();

        let treinoCache = {};

        function carregarTreino() {
            firestore.collection("workouts").doc(studentId).get().then((doc) => {
                if (doc.exists) {
                    treinoCache = doc.data().days || {};

                    // Detecta o dia da semana atual
                    const diasMap = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
                    const diaHj = diasMap[new Date().getDay()];

                    // Procura o elemento da aba correspondente ao dia de hoje
                    const tabs = document.querySelectorAll('.day-tab');
                    let tabHj = tabs[0]; // Fallback para primeira aba (Segunda)
                    tabs.forEach(t => {
                        // Verifica se o texto do botão contém parte do nome do dia atual
                        if (t.textContent.toLowerCase().includes(diaHj.substring(0, 3))) {
                            tabHj = t;
                        }
                    });

                    verDia(diaHj, tabHj);
                } else {
                    document.getElementById('treinoContainer').innerText = "Nenhum treino encontrado.";
                }
            });
        }

        window.verDia = function (dia, elBtn) {
            document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
            if (elBtn) elBtn.classList.add('active');

            const container = document.getElementById('treinoContainer');
            container.innerHTML = '';

            const exerciciosOriginal = treinoCache[dia] || [];

            // Cria uma cópia e ordena: os concluídos vão para o final
            const exercicios = [...exerciciosOriginal].sort((a, b) => {
                const aDone = isExCompleted(a.name, dia);
                const bDone = isExCompleted(b.name, dia);
                if (aDone && !bDone) return 1;
                if (!aDone && bDone) return -1;
                return 0;
            });

            if (exercicios.length === 0) {
                container.innerHTML = '<p>Descanso ou sem treino cadastrado.</p>';
                return;
            }

            exercicios.forEach((ex, index) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.id = `exercise-card-${index}`;
                div.style.marginBottom = '1rem';
                div.style.border = '1px solid #edf2f7';

                // Verifica se está concluído hoje (usando o id do exercício ou nome)
                const isCompleted = isExCompleted(ex.name, dia);
                if (isCompleted) div.classList.add('completed-exercise');

                let midia = '';
                if (ex.videoLink) midia += `<a href="${ex.videoLink}" target="_blank" class="btn btn-sm btn-primary">Ver Vídeo</a> `;
                if (ex.photoLink) midia += `<a href="${ex.photoLink}" target="_blank" class="btn btn-sm" style="background:#718096;color:#fff">Ver Foto</a>`;

                const rest = ex.restTime || 60;
                const min = Math.floor(rest / 60).toString().padStart(2, '0');
                const sec = (rest % 60).toString().padStart(2, '0');

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:1rem;">
                        <div>
                            <h3 style="color:var(--primary); margin-bottom:0.2rem;">${ex.name}</h3>
                            <p><strong>${ex.sets}</strong> Séries x <strong>${ex.reps}</strong> Repetições</p>
                            <p style="font-size: 0.9rem; font-weight: bold; color: var(--primary);">${rest}s</p>
                        </div>
                        <div>${midia}</div>
                    </div>
                    <div class="timer-container" id="timer-${ex.name.replace(/\s+/g, '-')}">
                        <div class="timer-display">${min}:${sec}</div>
                        <div class="timer-controls">
                            <button class="btn btn-sm btn-primary" onclick="toggleTimer(this, ${rest})">Iniciar Descanso</button>
                            <button class="btn btn-sm" style="background:#718096;color:#fff" onclick="resetTimer(this, ${rest})">Resetar</button>
                        </div>
                    </div>
                    <button class="${isCompleted ? 'btn-uncheck' : 'btn-check'}" onclick="toggleConcluido('${ex.name}', '${dia}', ${index})">
                        ${isCompleted ? 'Desmarcar' : '✓ Concluir Exercício'}
                    </button>
                `;
                container.appendChild(div);
            });
        };

        let activeTimers = {};

        window.toggleTimer = function (btn, restTime) {
            const container = btn.closest('.timer-container');
            const display = container.querySelector('.timer-display');
            const timerId = container.id;

            if (activeTimers[timerId] && activeTimers[timerId].running) {
                // Pausar
                clearInterval(activeTimers[timerId].interval);
                activeTimers[timerId].running = false;
                btn.innerText = 'Retomar';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-primary');
            } else {
                // Iniciar ou Retomar
                let timeLeft = (activeTimers[timerId] && activeTimers[timerId].timeLeft) ? activeTimers[timerId].timeLeft : restTime;

                btn.innerText = 'Pausar';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-danger');

                const interval = setInterval(() => {
                    timeLeft--;
                    if (activeTimers[timerId]) activeTimers[timerId].timeLeft = timeLeft;
                    updateDisplay(display, timeLeft);

                    if (timeLeft <= 0) {
                        clearInterval(interval);
                        delete activeTimers[timerId];
                        btn.innerText = 'Iniciar Descanso';
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-primary');
                        tocarAlarme();
                    }
                }, 1000);

                activeTimers[timerId] = { interval, timeLeft, running: true };
            }
        };

        window.resetTimer = function (btn, restTime) {
            const container = btn.closest('.timer-container');
            const display = container.querySelector('.timer-display');
            const timerId = container.id;
            const startBtn = container.querySelector('.timer-controls button:first-child');

            if (activeTimers[timerId]) {
                clearInterval(activeTimers[timerId].interval);
                delete activeTimers[timerId];
            }

            startBtn.innerText = 'Iniciar Descanso';
            startBtn.classList.remove('btn-danger');
            startBtn.classList.add('btn-primary');
            updateDisplay(display, restTime);
        };

        function updateDisplay(display, seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            display.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function tocarAlarme() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // Lá (A5)
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);

            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 10); // Toca por 10 segundos ou tempo que for definido
        }

        function isExCompleted(nome, dia) {
            const hoje = new Date().toISOString().split('T')[0];
            const logs = JSON.parse(localStorage.getItem(`progress_${studentId}_${hoje}`) || '{}');
            return logs[dia] && logs[dia].includes(nome);
        }

        window.toggleConcluido = function (nome, dia, index) {
            const hoje = new Date().toISOString().split('T')[0];
            const key = `progress_${studentId}_${hoje}`;
            let logs = JSON.parse(localStorage.getItem(key) || '{}');

            if (!logs[dia]) logs[dia] = [];

            const card = document.getElementById(`exercise-card-${index}`);

            if (logs[dia].includes(nome)) {
                logs[dia] = logs[dia].filter(n => n !== nome);
                card.classList.remove('completed-exercise');
            } else {
                logs[dia].push(nome);
                card.classList.add('completed-exercise');
            }

            localStorage.setItem(key, JSON.stringify(logs));
            verDia(dia, document.querySelector(`.day-tab.active`)); // Atualiza botões
        };

        carregarTreino();
    </script>
</body>

</html>