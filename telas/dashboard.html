<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Treinador - Rafael</title>
    <link rel="stylesheet" href="../css/style.css">

    <!-- Scripts Globais (Firebase Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../js/app_global.js"></script>

    <style>
        /* Estilos espec√≠ficos para o conte√∫do de cada dia no editor */
        .day-content {
            display: none;
            border: 1px solid var(--border);
            border-top: none;
            padding: 1rem;
            background: var(--white);
            border-radius: 0 0 8px 8px;
        }

        .exercise-row {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .exercise-row:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .exercise-inputs {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 0.5rem;
        }

        @media (max-width: 600px) {
            .exercise-inputs {
                grid-template-columns: 1fr 1fr;
            }
        }

        .day-content.active {
            display: block;
        }

        /* Toast de Notifica√ß√£o */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--success);
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }
    </style>
</head>

<body>

    <header class="container">
        <div class="app-header">
            <div>
                <h1>Painel do Treinador - <span id="trainerName">...</span></h1>
            </div>
            <div style="display:flex; gap:0.5rem;">
                <button onclick="abrirConfig()" class="btn btn-sm"
                    style="background:var(--text-muted); color:white">Configura√ß√µes</button>
                <button onclick="window.fazerLogout()" class="btn btn-danger btn-sm">Sair</button>
            </div>
        </div>
    </header>

    <main class="container">

        <!-- Se√ß√£o: Gerenciamento de Alunos -->
        <div class="card">
            <h2 style="margin-bottom: 1rem;">Meus Alunos</h2>

            <!-- Bot√£o para abrir o formul√°rio de cadastro -->
            <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <p style="color: var(--text-muted); font-size: 0.9rem;">Gerencie seus alunos e treinos.</p>
                <button onclick="toggleFormAluno()" class="btn btn-primary">+ Novo Aluno</button>
            </div>

            <!-- Formul√°rio para cadastrar novo aluno (escondido por padr√£o) -->
            <div id="formNovoAluno"
                style="display: none; background: #f8fafc; border: 1px solid var(--border); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 1rem;">Cadastrar Novo Aluno</h4>
                <div class="add-student-form"
                    style="display: flex; flex-direction: column; gap: 0.8rem; max-width: 400px;">
                    <div>
                        <label
                            style="font-size:0.8rem; color:var(--text-muted); display:block; margin-bottom:0.2rem;">Nome
                            Completo</label>
                        <input type="text" id="novoNome" placeholder="Ex: Jo√£o Silva" style="width: 100%;">
                    </div>
                    <div>
                        <label
                            style="font-size:0.8rem; color:var(--text-muted); display:block; margin-bottom:0.2rem;">Usu√°rio
                            de Acesso (Login)</label>
                        <input type="text" id="novoLogin" placeholder="Ex: joao.silva" style="width: 100%;">
                    </div>
                    <div>
                        <label
                            style="font-size:0.8rem; color:var(--text-muted); display:block; margin-bottom:0.2rem;">Senha
                            Inicial</label>
                        <input type="text" id="novaSenha" placeholder="Ex: 123456" style="width: 100%;">
                    </div>
                    <button onclick="adicionarAluno()" class="btn btn-primary" style="margin-top: 0.5rem;">Salvar
                        Cadastro</button>
                </div>
            </div>

            <!-- Campo de busca instant√¢nea -->
            <div style="margin-bottom: 1rem;">
                <input type="text" id="inputBusca" placeholder="Pesquisar aluno por nome..." onkeyup="filtrarAlunos()"
                    style="width: 100%;">
            </div>

            <!-- Tabela com a lista de alunos -->
            <div class="table-container">
                <table id="tabelaAlunos">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Login</th>
                            <th>Senha</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Modal: Editor de Treinos -->
        <!-- Exibido ao clicar em 'Treinos' na lista de alunos -->
        <div id="modalTreino" class="card"
            style="display: none; border: 2px solid var(--primary); position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; overflow-y: auto; z-index: 100;">
            <div class="app-header" style="box-shadow: none; padding: 0; margin-bottom: 1rem; background: none;">
                <h3>Editando Treino de: <span id="alunoEmEdicao" style="color: var(--primary);">...</span></h3>
                <button onclick="salvarEFechar()" class="btn btn-sm">Fechar e Salvar</button>
            </div>

            <!-- Abas para sele√ß√£o do dia da semana (Carousel fixo via style.css) -->
            <div class="days-carousel">
                <div class="day-tab active" onclick="mudarDia('segunda', this)">Segunda</div>
                <div class="day-tab" onclick="mudarDia('terca', this)">Ter√ßa</div>
                <div class="day-tab" onclick="mudarDia('quarta', this)">Quarta</div>
                <div class="day-tab" onclick="mudarDia('quinta', this)">Quinta</div>
                <div class="day-tab" onclick="mudarDia('sexta', this)">Sexta</div>
                <div class="day-tab" onclick="mudarDia('sabado', this)">S√°bado</div>
                <div class="day-tab" onclick="mudarDia('domingo', this)">Domingo</div>
            </div>

            <!-- Container onde os exerc√≠cios do dia selecionado ser√£o renderizados -->
            <div id="containerDias"></div>
        </div>

        <!-- Modal: Configura√ß√µes da Conta -->
        <div id="modalConfig" class="card"
            style="display: none; border: 2px solid var(--text-muted); position: fixed; top: 20%; left: 50%; width: 400px; transform: translateX(-50%); z-index: 101;">
            <h3>Configura√ß√µes da Conta</h3>
            <p style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-muted);">Mude seu usu√°rio e senha de
                acesso.</p>

            <input type="text" id="configUsername" placeholder="Novo Usu√°rio">
            <input type="password" id="configPassword" placeholder="Nova Senha">

            <div style="display:flex; gap:0.5rem; margin-top: 1rem;">
                <button onclick="salvarConfig()" class="btn btn-primary" style="flex:1">Salvar</button>
                <button onclick="fecharConfig()" class="btn btn-sm" style="flex:1">Cancelar</button>
            </div>
        </div>

        <!-- Modal: Editar Aluno -->
        <div id="modalEditarAluno" class="card"
            style="display: none; border: 2px solid var(--primary); position: fixed; top: 20%; left: 50%; width: 400px; transform: translateX(-50%); z-index: 101;">
            <h3>Editar Aluno</h3>
            <p style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-muted);">Altere as informa√ß√µes do aluno.
            </p>

            <input type="text" id="editNome" placeholder="Nome do Aluno">
            <input type="text" id="editLogin" placeholder="Login">
            <input type="text" id="editSenha" placeholder="Nova Senha (deixe em branco para manter)">

            <div style="display:flex; gap:0.5rem; margin-top: 1rem;">
                <button onclick="salvarEdicaoAluno()" class="btn btn-primary" style="flex:1">Salvar Altera√ß√µes</button>
                <button onclick="fecharEdicaoAluno()" class="btn btn-sm" style="flex:1">Cancelar</button>
            </div>
        </div>

    </main>

    <div id="toast">Opera√ß√£o conclu√≠da!</div>

    <script>
        // L√≥gica da P√°gina (Utilizando vari√°veis e fun√ß√µes do app_global.js)

        // Prote√ß√£o: Verifica se o personal est√° realmente logado
        window.verificarAuthDashboard();
        document.getElementById('trainerName').innerText = sessionStorage.getItem("adminName") || 'Treinador';

        const firestore = firebase.firestore();
        const tabela = document.querySelector('#tabelaAlunos tbody');
        const modal = document.getElementById('modalTreino');

        let alunoEdicaoId = null; // ID do aluno que est√° com o editor aberto
        let diaAtual = 'segunda'; // Dia selecionado no editor
        let treinoCache = {}; // Objeto que armazena as altera√ß√µes tempor√°rias no treino
        let alunosLocal = []; // Lista carregada do Firestore para busca local r√°pida
        const diasSemana = ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado', 'domingo'];

        /**
         * Inicializa o cache do treino com arrays vazios para cada dia
         */
        function resetCache() {
            treinoCache = {};
            diasSemana.forEach(d => treinoCache[d] = []);
        }

        // --- CRUD DE ALUNOS ---

        /**
         * Busca todos os alunos cadastrados no Firestore
         */
        function carregarAlunos() {
            tabela.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
            firestore.collection("students").get().then((querySnapshot) => {
                alunosLocal = [];
                querySnapshot.forEach((doc) => {
                    alunosLocal.push({ id: doc.id, ...doc.data() });
                });
                renderizarTabelaAlunos(alunosLocal);
            }).catch(error => {
                console.error("Erro ao carregar:", error);
                // Tratamento espec√≠fico para regras de seguran√ßa do Firebase
                if (error.code === 'permission-denied') {
                    tabela.innerHTML = '<tr><td colspan="4" style="color:red; font-weight:bold;">ERRO DE PERMISS√ÉO: O Firebase bloqueou o acesso.<br>Verifique se voc√™ alterou as Regras para "true" conforme o guia.</td></tr>';
                    alert("O BANCO DE DADOS EST√Å BLOQUEADO!\n\nVoc√™ precisa ir no Console do Firebase > Firestore Database > Regras\nE trocar 'false' por 'true'.");
                } else {
                    tabela.innerHTML = '<tr><td colspan="4" style="color:red;">Erro ao carregar: ' + error.message + '</td></tr>';
                }
            });
        }

        window.toggleFormAluno = function () {
            const form = document.getElementById('formNovoAluno');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        };

        /**
         * Renderiza as linhas da tabela de alunos com base em uma lista (filtro ou completa)
         */
        function renderizarTabelaAlunos(lista) {
            tabela.innerHTML = '';
            if (lista.length === 0) {
                const buscaValor = document.getElementById('inputBusca').value;
                const mensagem = buscaValor ? 'Aluno n√£o existente' : 'Nenhum aluno cadastrado.';
                tabela.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 2rem; color: var(--text-muted);">${mensagem}</td></tr>`;
                return;
            }
            lista.forEach((aluno) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${aluno.name}</td>
                    <td>${aluno.login}</td>
                    <td>${aluno.passwordPlain || aluno.password}</td>
                    <td>
                        <button class="btn btn-sm" style="background:var(--text-muted); color:white" onclick="abrirEdicaoAluno('${aluno.id}')">Editar</button>
                        <button class="btn btn-sm btn-primary" onclick="abrirEditor('${aluno.id}', '${aluno.name}')">Treinos</button>
                        <button class="btn btn-sm btn-danger" onclick="excluirAluno('${aluno.id}')">X</button>
                    </td>
                `;
                tabela.appendChild(tr);
            });
        }

        /**
         * Filtra a lista de alunos localmente conforme o texto digitado
         */
        window.filtrarAlunos = function () {
            const termo = document.getElementById('inputBusca').value.toLowerCase().trim();
            const filtrados = alunosLocal.filter(a => a.name.toLowerCase().includes(termo));
            renderizarTabelaAlunos(filtrados);
        };

        /**
         * Adiciona um novo aluno ao banco de dados
         */
        window.adicionarAluno = async function () {
            const name = document.getElementById('novoNome').value;
            const login = document.getElementById('novoLogin').value;
            const password = document.getElementById('novaSenha').value;

            if (!name || !login || !password) return alert("Preencha todos os campos.");

            try {
                const senhaHash = await window.hashSenha(password);
                await firestore.collection("students").add({
                    name,
                    login,
                    password: senhaHash,
                    passwordPlain: password, // Salva em texto puro para o treinador ver
                    createdAt: new Date()
                });

                // Limpa campos ap√≥s salvar
                document.getElementById('novoNome').value = '';
                document.getElementById('novoLogin').value = '';
                document.getElementById('novaSenha').value = '';
                toggleFormAluno(); // Esconde o formul√°rio ap√≥s salvar
                carregarAlunos();
                showToast("Aluno cadastrado com sucesso! üë§");
            } catch (e) {
                alert("Erro ao cadastrar: " + e.message);
            }
        };

        /**
         * Remove um aluno e seus dados (Nota: N√£o apaga os treinos automaticamente nesta vers√£o simples)
         */
        window.excluirAluno = function (id) {
            if (confirm("Excluir este aluno definitivamente?")) {
                firestore.collection("students").doc(id).delete().then(() => {
                    carregarAlunos();
                    showToast("Aluno exclu√≠do. üóëÔ∏è");
                });
            }
        };

        // --- EDI√á√ÉO DE PERFIL DO ALUNO ---

        let alunoPerfilId = null;

        window.abrirEdicaoAluno = function (id) {
            const aluno = alunosLocal.find(a => a.id === id);
            if (!aluno) return;

            alunoPerfilId = id;
            document.getElementById('editNome').value = aluno.name;
            document.getElementById('editLogin').value = aluno.login;
            document.getElementById('editSenha').value = ''; // Sempre limpo por seguran√ßa
            document.getElementById('modalEditarAluno').style.display = 'block';
        };

        window.fecharEdicaoAluno = function () {
            document.getElementById('modalEditarAluno').style.display = 'none';
        };

        window.salvarEdicaoAluno = async function () {
            const nome = document.getElementById('editNome').value.trim();
            const login = document.getElementById('editLogin').value.trim();
            const novaSenha = document.getElementById('editSenha').value.trim();

            if (!nome || !login) return alert("Preencha nome e login.");

            const updates = { name: nome, login: login };

            try {
                if (novaSenha) {
                    updates.password = await window.hashSenha(novaSenha);
                    updates.passwordPlain = novaSenha; // Atualiza o texto puro para o treinador
                }

                await firestore.collection("students").doc(alunoPerfilId).update(updates);

                showToast("Perfil atualizado! ‚úÖ");
                fecharEdicaoAluno();
                carregarAlunos();
            } catch (e) {
                alert("Erro ao editar: " + e.message);
            }
        };

        // --- EDITOR DE TREINOS ---

        /**
         * Abre o modal de edi√ß√£o e carrega os treinos do aluno selecionado
         */
        window.abrirEditor = function (id, nome) {
            alunoEdicaoId = id;
            document.getElementById('alunoEmEdicao').innerText = nome;
            modal.style.display = 'block';

            // Busca os treinos na cole√ß√£o 'workouts' usando o ID do aluno como chave
            firestore.collection("workouts").doc(id).get().then((doc) => {
                if (doc.exists) {
                    treinoCache = doc.data().days || {};
                    // Garante que todos os dias existam no cache, mesmo os vazios
                    diasSemana.forEach(d => { if (!treinoCache[d]) treinoCache[d] = []; });
                } else {
                    resetCache();
                }

                // Detecta o dia da semana atual para abrir o editor nele
                const diasMap = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
                const diaHj = diasMap[new Date().getDay()];

                // Encontra a aba do dia de hoje
                const tabs = document.querySelectorAll('#modalTreino .day-tab');
                let elHj = null;
                tabs.forEach(t => {
                    if (t.textContent.toLowerCase().includes(diaHj.substring(0, 3))) elHj = t;
                });

                mudarDia(diaHj, elHj);
            });
        };

        /**
         * Troca o dia visualizado no editor de treinos
         */
        window.mudarDia = function (dia, el) {
            diaAtual = dia;
            // Atualiza o estado visual das abas
            document.querySelectorAll('.day-tab').forEach(tab => tab.classList.remove('active'));
            if (el) {
                el.classList.add('active');
            } else {
                // Fallback para destacar 'Segunda' ao abrir o modal
                document.querySelectorAll('.day-tab').forEach(tab => {
                    if (tab.textContent.toLowerCase() === 'segunda') tab.classList.add('active');
                });
            }
            renderizarDia();
        };

        /**
         * Renderiza os formul√°rios dos exerc√≠cios do dia atual
         */
        function renderizarDia() {
            const container = document.getElementById('containerDias');
            container.innerHTML = '';

            const exercicios = treinoCache[diaAtual] || [];

            const divDia = document.createElement('div');
            divDia.className = 'day-content active';
            divDia.innerHTML = `
                <h4 style="margin-bottom:1rem; text-transform: capitalize;">${diaAtual}</h4>
                <div id="listaExercicio"></div>
                <button onclick="addExercicioNoDia()" class="btn btn-sm btn-primary" style="margin-top:1rem">+ Adicionar Exerc√≠cio</button>
            `;
            container.appendChild(divDia);

            const lista = divDia.querySelector(`#listaExercicio`);
            exercicios.forEach((ex, index) => {
                const row = document.createElement('div');
                row.className = 'exercise-row';
                row.innerHTML = `
                    <div style="margin-bottom: 0.5rem; font-weight: bold; color: var(--primary);">#${index + 1} - Exerc√≠cio</div>
                    <div class="exercise-inputs">
                        <div>
                            <label style="font-size:0.7rem; color:var(--text-muted);">Nome</label>
                            <input type="text" value="${ex.name}" placeholder="Ex: Supino Reto" onchange="updateEx(${index}, 'name', this.value)" style="width:100%">
                        </div>
                        <div>
                            <label style="font-size:0.7rem; color:var(--text-muted);">S√©ries</label>
                            <input type="text" value="${ex.sets}" placeholder="4" onchange="updateEx(${index}, 'sets', this.value)" style="width:100%">
                        </div>
                        <div>
                            <label style="font-size:0.7rem; color:var(--text-muted);">Reps</label>
                            <input type="text" value="${ex.reps}" placeholder="12" onchange="updateEx(${index}, 'reps', this.value)" style="width:100%">
                        </div>
                        <div>
                            <label style="font-size:0.7rem; color:var(--text-muted);">Desc.(s)</label>
                            <input type="number" value="${ex.restTime || 60}" placeholder="60" onchange="updateEx(${index}, 'restTime', this.value)" style="width:100%">
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap: 0.5rem; margin-top: 0.5rem; align-items: end;">
                        <div>
                            <label style="font-size:0.7rem; color:var(--text-muted);">V√≠deo (URL)</label>
                            <input type="text" value="${ex.videoLink || ''}" placeholder="Link YouTube" onchange="updateEx(${index}, 'videoLink', this.value)" style="width:100%">
                        </div>
                        <div>
                            <label style="font-size:0.7rem; color:var(--text-muted);">Foto (URL)</label>
                            <input type="text" value="${ex.photoLink || ''}" placeholder="URL da Imagem" onchange="updateEx(${index}, 'photoLink', this.value)" style="width:100%">
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeEx(${index})" style="height: 38px;">Remover</button>
                    </div>
                `;
                lista.appendChild(row);
            });
        }

        /**
         * Adiciona uma linha vazia de exerc√≠cio no dia selecionado
         */
        window.addExercicioNoDia = function () {
            if (!treinoCache[diaAtual]) treinoCache[diaAtual] = [];
            // Cria objeto padr√£o com descanso de 60s
            treinoCache[diaAtual].push({ name: '', sets: '', reps: '', restTime: 60, videoLink: '', photoLink: '' });
            renderizarDia();
        };

        /**
         * Atualiza o valor de um campo de exerc√≠cio no cache
         */
        window.updateEx = function (index, field, value) {
            treinoCache[diaAtual][index][field] = value;
        };

        /**
         * Remove um exerc√≠cio do dia atual no cache
         */
        window.removeEx = function (index) {
            treinoCache[diaAtual].splice(index, 1);
            renderizarDia();
        };

        /**
         * Salva o objeto treinoCache no documento do aluno no Firestore
         */
        window.salvarEFechar = function () {
            if (!alunoEdicaoId) return;
            firestore.collection("workouts").doc(alunoEdicaoId).set({
                days: treinoCache,
                updatedAt: new Date()
            }).then(() => {
                showToast("Treino salvo com sucesso! ‚úÖ");
                modal.style.display = 'none';
            }).catch(e => alert("Erro ao salvar: " + e));
        };

        // --- CONFIGURA√á√ïES DA CONTA ---

        window.showToast = function (msg) {
            const toast = document.getElementById("toast");
            toast.innerText = msg;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        };

        window.abrirConfig = function () {
            document.getElementById('modalConfig').style.display = 'block';
        };

        window.fecharConfig = function () {
            document.getElementById('modalConfig').style.display = 'none';
        };

        window.salvarConfig = async function () {
            const novoUser = document.getElementById('configUsername').value.trim();
            const novaSenha = document.getElementById('configPassword').value.trim();

            if (!novoUser || !novaSenha) return alert("Preencha usu√°rio e senha.");

            try {
                const senhaHash = await window.hashSenha(novaSenha);
                const adminId = sessionStorage.getItem("adminId");

                if (adminId) {
                    await firestore.collection("admins").doc(adminId).update({
                        username: novoUser,
                        password: senhaHash
                    });
                } else {
                    // Fallback se por algum motivo o ID n√£o estiver no session
                    await firestore.collection("admins").add({
                        username: novoUser,
                        password: senhaHash
                    });
                }

                showToast("Credenciais atualizadas! ‚úÖ");
                fecharConfig();
            } catch (e) {
                alert("Erro ao salvar configura√ß√µes: " + e.message);
            }
        };

        // Carregamento inicial da p√°gina
        carregarAlunos();

    </script>
</body>

</html>