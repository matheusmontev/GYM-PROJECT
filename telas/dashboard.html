<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Treinador - Rafael</title>
    <link rel="stylesheet" href="../css/style.css">

    <!-- Scripts Globais (Firebase Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../js/app_global.js"></script>

    <style>
        /* Estilos específicos para o conteúdo de cada dia no editor */
        .day-content {
            display: none;
            border: 1px solid var(--border);
            border-top: none;
            padding: 1rem;
            background: var(--white);
            border-radius: 0 0 8px 8px;
        }

        .day-content.active {
            display: block;
        }
    </style>
</head>

<body>

    <header class="container">
        <div class="app-header">
            <div>
                <h1>Painel do Treinador - <span id="trainerName">...</span></h1>
            </div>
            <div style="display:flex; gap:0.5rem;">
                <button onclick="abrirConfig()" class="btn btn-sm"
                    style="background:var(--text-muted); color:white">Configurações</button>
                <button onclick="window.fazerLogout()" class="btn btn-danger btn-sm">Sair</button>
            </div>
        </div>
    </header>

    <main class="container">

        <!-- Seção: Gerenciamento de Alunos -->
        <div class="card">
            <h2 style="margin-bottom: 1rem;">Meus Alunos</h2>

            <!-- Formulário para cadastrar novo aluno -->
            <div class="add-student-form" style="margin-bottom: 1.5rem;">
                <input type="text" id="novoNome" placeholder="Nome do Aluno">
                <input type="text" id="novoLogin" placeholder="Login (ex: joao)">
                <input type="text" id="novaSenha" placeholder="Senha (ex: 1234)">
                <button onclick="adicionarAluno()" class="btn btn-primary">+ Cadastrar</button>
            </div>

            <!-- Campo de busca instantânea -->
            <div style="margin-bottom: 1rem;">
                <input type="text" id="inputBusca" placeholder="Pesquisar aluno por nome..." onkeyup="filtrarAlunos()"
                    style="width: 100%;">
            </div>

            <!-- Tabela com a lista de alunos -->
            <div class="table-container">
                <table id="tabelaAlunos">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Login</th>
                            <th>Senha</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Modal: Editor de Treinos -->
        <!-- Exibido ao clicar em 'Treinos' na lista de alunos -->
        <div id="modalTreino" class="card"
            style="display: none; border: 2px solid var(--primary); position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; overflow-y: auto; z-index: 100;">
            <div class="app-header" style="box-shadow: none; padding: 0; margin-bottom: 1rem; background: none;">
                <h3>Editando Treino de: <span id="alunoEmEdicao" style="color: var(--primary);">...</span></h3>
                <button onclick="salvarEFechar()" class="btn btn-sm">Fechar e Salvar</button>
            </div>

            <!-- Abas para seleção do dia da semana (Carousel fixo via style.css) -->
            <div class="days-carousel">
                <div class="day-tab active" onclick="mudarDia('segunda', this)">Segunda</div>
                <div class="day-tab" onclick="mudarDia('terca', this)">Terça</div>
                <div class="day-tab" onclick="mudarDia('quarta', this)">Quarta</div>
                <div class="day-tab" onclick="mudarDia('quinta', this)">Quinta</div>
                <div class="day-tab" onclick="mudarDia('sexta', this)">Sexta</div>
                <div class="day-tab" onclick="mudarDia('sabado', this)">Sábado</div>
                <div class="day-tab" onclick="mudarDia('domingo', this)">Domingo</div>
            </div>

            <!-- Container onde os exercícios do dia selecionado serão renderizados -->
            <div id="containerDias"></div>
        </div>

        <!-- Modal: Configurações da Conta -->
        <div id="modalConfig" class="card"
            style="display: none; border: 2px solid var(--text-muted); position: fixed; top: 20%; left: 50%; width: 400px; transform: translateX(-50%); z-index: 101;">
            <h3>Configurações da Conta</h3>
            <p style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-muted);">Mude seu usuário e senha de
                acesso.</p>

            <input type="text" id="configUsername" placeholder="Novo Usuário">
            <input type="password" id="configPassword" placeholder="Nova Senha">

            <div style="display:flex; gap:0.5rem; margin-top: 1rem;">
                <button onclick="salvarConfig()" class="btn btn-primary" style="flex:1">Salvar</button>
                <button onclick="fecharConfig()" class="btn btn-sm" style="flex:1">Cancelar</button>
            </div>
        </div>

    </main>

    <script>
        // Lógica da Página (Utilizando variáveis e funções do app_global.js)

        // Proteção: Verifica se o personal está realmente logado
        window.verificarAuthDashboard();
        document.getElementById('trainerName').innerText = sessionStorage.getItem("adminName") || 'Treinador';

        const firestore = firebase.firestore();
        const tabela = document.querySelector('#tabelaAlunos tbody');
        const modal = document.getElementById('modalTreino');

        let alunoEdicaoId = null; // ID do aluno que está com o editor aberto
        let diaAtual = 'segunda'; // Dia selecionado no editor
        let treinoCache = {}; // Objeto que armazena as alterações temporárias no treino
        let alunosLocal = []; // Lista carregada do Firestore para busca local rápida
        const diasSemana = ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado', 'domingo'];

        /**
         * Inicializa o cache do treino com arrays vazios para cada dia
         */
        function resetCache() {
            treinoCache = {};
            diasSemana.forEach(d => treinoCache[d] = []);
        }

        // --- CRUD DE ALUNOS ---

        /**
         * Busca todos os alunos cadastrados no Firestore
         */
        function carregarAlunos() {
            tabela.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';
            firestore.collection("students").get().then((querySnapshot) => {
                alunosLocal = [];
                querySnapshot.forEach((doc) => {
                    alunosLocal.push({ id: doc.id, ...doc.data() });
                });
                renderizarTabelaAlunos(alunosLocal);
            }).catch(error => {
                console.error("Erro ao carregar:", error);
                // Tratamento específico para regras de segurança do Firebase
                if (error.code === 'permission-denied') {
                    tabela.innerHTML = '<tr><td colspan="4" style="color:red; font-weight:bold;">ERRO DE PERMISSÃO: O Firebase bloqueou o acesso.<br>Verifique se você alterou as Regras para "true" conforme o guia.</td></tr>';
                    alert("O BANCO DE DADOS ESTÁ BLOQUEADO!\n\nVocê precisa ir no Console do Firebase > Firestore Database > Regras\nE trocar 'false' por 'true'.");
                } else {
                    tabela.innerHTML = '<tr><td colspan="4" style="color:red;">Erro ao carregar: ' + error.message + '</td></tr>';
                }
            });
        }

        /**
         * Renderiza as linhas da tabela de alunos com base em uma lista (filtro ou completa)
         */
        function renderizarTabelaAlunos(lista) {
            tabela.innerHTML = '';
            if (lista.length === 0) {
                const buscaValor = document.getElementById('inputBusca').value;
                const mensagem = buscaValor ? 'Aluno não existente' : 'Nenhum aluno cadastrado.';
                tabela.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 2rem; color: var(--text-muted);">${mensagem}</td></tr>`;
                return;
            }
            lista.forEach((aluno) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${aluno.name}</td>
                    <td>${aluno.login}</td>
                    <td>${aluno.passwordPlain || aluno.password}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="abrirEditor('${aluno.id}', '${aluno.name}')">Treinos</button>
                        <button class="btn btn-sm btn-danger" onclick="excluirAluno('${aluno.id}')">X</button>
                    </td>
                `;
                tabela.appendChild(tr);
            });
        }

        /**
         * Filtra a lista de alunos localmente conforme o texto digitado
         */
        window.filtrarAlunos = function () {
            const termo = document.getElementById('inputBusca').value.toLowerCase().trim();
            const filtrados = alunosLocal.filter(a => a.name.toLowerCase().includes(termo));
            renderizarTabelaAlunos(filtrados);
        };

        /**
         * Adiciona um novo aluno ao banco de dados
         */
        window.adicionarAluno = async function () {
            const name = document.getElementById('novoNome').value;
            const login = document.getElementById('novoLogin').value;
            const password = document.getElementById('novaSenha').value;

            if (!name || !login || !password) return alert("Preencha todos os campos.");

            try {
                const senhaHash = await window.hashSenha(password);
                await firestore.collection("students").add({
                    name,
                    login,
                    password: senhaHash,
                    passwordPlain: password, // Salva em texto puro para o treinador ver
                    createdAt: new Date()
                });

                // Limpa campos após salvar
                document.getElementById('novoNome').value = '';
                document.getElementById('novoLogin').value = '';
                document.getElementById('novaSenha').value = '';
                carregarAlunos();
                alert("Aluno cadastrado com sucesso!");
            } catch (e) {
                alert("Erro ao cadastrar: " + e.message);
            }
        };

        /**
         * Remove um aluno e seus dados (Nota: Não apaga os treinos automaticamente nesta versão simples)
         */
        window.excluirAluno = function (id) {
            if (confirm("Excluir este aluno definitivamente?")) {
                firestore.collection("students").doc(id).delete().then(carregarAlunos);
            }
        };

        // --- EDITOR DE TREINOS ---

        /**
         * Abre o modal de edição e carrega os treinos do aluno selecionado
         */
        window.abrirEditor = function (id, nome) {
            alunoEdicaoId = id;
            document.getElementById('alunoEmEdicao').innerText = nome;
            modal.style.display = 'block';

            // Busca os treinos na coleção 'workouts' usando o ID do aluno como chave
            firestore.collection("workouts").doc(id).get().then((doc) => {
                if (doc.exists) {
                    treinoCache = doc.data().days || {};
                    // Garante que todos os dias existam no cache, mesmo os vazios
                    diasSemana.forEach(d => { if (!treinoCache[d]) treinoCache[d] = []; });
                } else {
                    resetCache();
                }

                // Detecta o dia da semana atual para abrir o editor nele
                const diasMap = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
                const diaHj = diasMap[new Date().getDay()];

                // Encontra a aba do dia de hoje
                const tabs = document.querySelectorAll('#modalTreino .day-tab');
                let elHj = null;
                tabs.forEach(t => {
                    if (t.textContent.toLowerCase().includes(diaHj.substring(0, 3))) elHj = t;
                });

                mudarDia(diaHj, elHj);
            });
        };

        /**
         * Troca o dia visualizado no editor de treinos
         */
        window.mudarDia = function (dia, el) {
            diaAtual = dia;
            // Atualiza o estado visual das abas
            document.querySelectorAll('.day-tab').forEach(tab => tab.classList.remove('active'));
            if (el) {
                el.classList.add('active');
            } else {
                // Fallback para destacar 'Segunda' ao abrir o modal
                document.querySelectorAll('.day-tab').forEach(tab => {
                    if (tab.textContent.toLowerCase() === 'segunda') tab.classList.add('active');
                });
            }
            renderizarDia();
        };

        /**
         * Renderiza os formulários dos exercícios do dia atual
         */
        function renderizarDia() {
            const container = document.getElementById('containerDias');
            container.innerHTML = '';

            const exercicios = treinoCache[diaAtual] || [];

            const divDia = document.createElement('div');
            divDia.className = 'day-content active';
            divDia.innerHTML = `
                <h4 style="margin-bottom:1rem; text-transform: capitalize;">${diaAtual}</h4>
                <div id="listaExercicio"></div>
                <button onclick="addExercicioNoDia()" class="btn btn-sm btn-primary" style="margin-top:1rem">+ Adicionar Exercício</button>
            `;
            container.appendChild(divDia);

            const lista = divDia.querySelector(`#listaExercicio`);
            exercicios.forEach((ex, index) => {
                const row = document.createElement('div');
                row.className = 'exercise-row';
                row.innerHTML = `
                    <div class="exercise-inputs">
                        <input type="text" value="${ex.name}" placeholder="Nome do Exercício" onchange="updateEx(${index}, 'name', this.value)">
                        <input type="text" value="${ex.sets}" placeholder="Séries" onchange="updateEx(${index}, 'sets', this.value)">
                        <input type="text" value="${ex.reps}" placeholder="Repetições" onchange="updateEx(${index}, 'reps', this.value)">
                        <input type="number" value="${ex.restTime || 60}" placeholder="Descanso (s)" title="Tempo em segundos" onchange="updateEx(${index}, 'restTime', this.value)">
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr; gap: 0.5rem; margin-top: 0.5rem;">
                        <input type="text" value="${ex.videoLink || ''}" placeholder="Link Vídeo (YouTube)" onchange="updateEx(${index}, 'videoLink', this.value)">
                        <input type="text" value="${ex.photoLink || ''}" placeholder="Link Foto (URL)" onchange="updateEx(${index}, 'photoLink', this.value)">
                        <button class="btn btn-sm btn-danger" onclick="removeEx(${index})">Remover Exercício</button>
                    </div>
                `;
                lista.appendChild(row);
            });
        }

        /**
         * Adiciona uma linha vazia de exercício no dia selecionado
         */
        window.addExercicioNoDia = function () {
            if (!treinoCache[diaAtual]) treinoCache[diaAtual] = [];
            // Cria objeto padrão com descanso de 60s
            treinoCache[diaAtual].push({ name: '', sets: '', reps: '', restTime: 60, videoLink: '', photoLink: '' });
            renderizarDia();
        };

        /**
         * Atualiza o valor de um campo de exercício no cache
         */
        window.updateEx = function (index, field, value) {
            treinoCache[diaAtual][index][field] = value;
        };

        /**
         * Remove um exercício do dia atual no cache
         */
        window.removeEx = function (index) {
            treinoCache[diaAtual].splice(index, 1);
            renderizarDia();
        };

        /**
         * Salva o objeto treinoCache no documento do aluno no Firestore
         */
        window.salvarEFechar = function () {
            if (!alunoEdicaoId) return;
            firestore.collection("workouts").doc(alunoEdicaoId).set({
                days: treinoCache,
                updatedAt: new Date()
            }).then(() => {
                alert("Treino salvo com sucesso!");
                modal.style.display = 'none';
            }).catch(e => alert("Erro ao salvar: " + e));
        };

        // --- CONFIGURAÇÕES DA CONTA ---

        window.abrirConfig = function () {
            document.getElementById('modalConfig').style.display = 'block';
        };

        window.fecharConfig = function () {
            document.getElementById('modalConfig').style.display = 'none';
        };

        window.salvarConfig = async function () {
            const novoUser = document.getElementById('configUsername').value.trim();
            const novaSenha = document.getElementById('configPassword').value.trim();

            if (!novoUser || !novaSenha) return alert("Preencha usuário e senha.");

            try {
                const senhaHash = await window.hashSenha(novaSenha);
                const adminId = sessionStorage.getItem("adminId");

                if (adminId) {
                    await firestore.collection("admins").doc(adminId).update({
                        username: novoUser,
                        password: senhaHash
                    });
                } else {
                    // Fallback se por algum motivo o ID não estiver no session
                    await firestore.collection("admins").add({
                        username: novoUser,
                        password: senhaHash
                    });
                }

                alert("Credenciais atualizadas com sucesso! Use-as no próximo login.");
                fecharConfig();
            } catch (e) {
                alert("Erro ao salvar configurações: " + e.message);
            }
        };

        // Carregamento inicial da página
        carregarAlunos();

    </script>
</body>

</html>